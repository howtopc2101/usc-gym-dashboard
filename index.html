<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>USC Gym Live</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
      :root {
        --bg-main: #05060b;
        --bg-elevated: rgba(18, 22, 34, 0.9);
        --bg-elevated-soft: rgba(18, 22, 34, 0.75);
        --border-subtle: rgba(255, 255, 255, 0.08);
        --text-primary: #f5f7ff;
        --text-secondary: rgba(230, 235, 255, 0.75);
        --text-muted: rgba(190, 198, 230, 0.55);
        --accent: #0a84ff;     /* Apple blue */
        --accent-soft: rgba(10, 132, 255, 0.18);
        --danger: #ff453a;
        --ok: #30d158;
        --warning: #ffd60a;
        --radius-xl: 22px;
        --radius-pill: 999px;
        --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.55);
        --shadow-subtle: 0 0 0 0.5px rgba(255, 255, 255, 0.04);
        --card-padding: 18px 20px;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "SF Pro Display", Arial, sans-serif;
        background:
          radial-gradient(circle at 0% -20%, #1b2842 0, transparent 55%),
          radial-gradient(circle at 100% 120%, #141927 0, transparent 55%),
          linear-gradient(135deg, #02040a, #05060b 60%, #050509);
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
        padding: 16px 20px 28px;
      }

      .app-shell {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      /* Top bar */

      .top-bar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
      }

      .top-left {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .app-title-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .status-dot {
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: var(--accent);
        box-shadow: 0 0 0 4px var(--accent-soft);
      }

      h1 {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.02em;
        margin: 0;
      }

      .subtitle {
        font-size: 13px;
        color: var(--text-muted);
      }

      .top-right {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .chip {
        border-radius: var(--radius-pill);
        padding: 4px 11px;
        background: rgba(15, 20, 30, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 11px;
        color: var(--text-secondary);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .pill-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: var(--ok);
      }

      /* Layout grid */

      .grid {
        display: grid;
        grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.2fr);
        grid-template-rows: auto auto;
        grid-template-areas:
          "today current"
          "weekly highlights";
        gap: 16px;
      }

      @media (max-width: 960px) {
        .grid {
          grid-template-columns: minmax(0, 1fr);
          grid-template-areas:
            "today"
            "current"
            "weekly"
            "highlights";
        }
      }

      .card {
        background: var(--bg-elevated-soft);
        backdrop-filter: blur(26px);
        -webkit-backdrop-filter: blur(26px);
        border-radius: var(--radius-xl);
        border: 1px solid var(--border-subtle);
        box-shadow: var(--shadow-soft), var(--shadow-subtle);
        padding: var(--card-padding);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at top left,
          rgba(88, 102, 255, 0.28),
          transparent 60%
        );
        opacity: 0.16;
        pointer-events: none;
      }

      .card-inner {
        position: relative;
        z-index: 1;
      }

      .card-header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 12px;
      }

      .card-title-group {
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .card-title {
        font-size: 14px;
        font-weight: 600;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: var(--text-secondary);
      }

      .card-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .card-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }

      .select-wrapper {
        position: relative;
      }

      .select-wrapper select {
        appearance: none;
        -webkit-appearance: none;
        background: rgba(3, 10, 24, 0.85);
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: var(--radius-pill);
        padding: 6px 28px 6px 11px;
        color: var(--text-primary);
        font-size: 12px;
        outline: none;
      }

      .select-wrapper::after {
        content: "▾";
        position: absolute;
        right: 9px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        color: var(--text-secondary);
        pointer-events: none;
      }

      .meta-label {
        font-size: 11px;
        color: var(--text-muted);
      }

      .meta-value {
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Today vs usual */

      #today-card {
        grid-area: today;
      }

      .today-main-row {
        display: flex;
        gap: 16px;
        align-items: flex-start;
      }

      .today-score {
        min-width: 70px;
      }

      .today-score-value {
        font-size: 32px;
        font-weight: 600;
        line-height: 1;
        margin-bottom: 2px;
      }

      .today-score-label {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .pill-status {
        border-radius: var(--radius-pill);
        font-size: 11px;
        padding: 3px 8px;
        background: rgba(255, 214, 10, 0.14);
        color: #ffd60a;
        border: 1px solid rgba(255, 214, 10, 0.4);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .pill-status.ok {
        background: rgba(48, 209, 88, 0.12);
        color: var(--ok);
        border-color: rgba(48, 209, 88, 0.45);
      }

      .pill-status.busy {
        background: rgba(255, 69, 58, 0.12);
        color: var(--danger);
        border-color: rgba(255, 69, 58, 0.48);
      }

      .pill-status-dot {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: currentColor;
      }

      .chart-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      canvas {
        width: 100%;
        max-width: 100%;
      }

      .chart-legend {
        display: flex;
        gap: 10px;
        font-size: 11px;
        color: var(--text-muted);
      }

      .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .legend-swatch {
        width: 18px;
        height: 3px;
        border-radius: 999px;
      }

      .legend-today {
        background: var(--accent);
      }

      .legend-typical {
        background: rgba(255, 255, 255, 0.5);
      }

      .chart-caption {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      /* Current room card */

      #current-card {
        grid-area: current;
      }

      .current-header-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 8px;
      }

      .current-count {
        font-size: 26px;
        font-weight: 600;
      }

      .current-capacity {
        font-size: 14px;
        color: var(--text-secondary);
      }

      .current-label {
        font-size: 12px;
        color: var(--text-muted);
      }

      .current-updated {
        font-size: 11px;
        color: var(--text-muted);
      }

      .mini-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        margin-top: 14px;
      }

      .mini-card {
        background: linear-gradient(
          145deg,
          rgba(10, 12, 22, 0.98),
          rgba(14, 20, 36, 0.98)
        );
        border-radius: 16px;
        padding: 10px 11px;
        border: 1px solid rgba(255, 255, 255, 0.07);
        display: flex;
        justify-content: space-between;
        gap: 6px;
      }

      .mini-name {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 3px;
      }

      .mini-sub {
        font-size: 11px;
        color: var(--text-muted);
      }

      .mini-value {
        font-size: 14px;
        font-weight: 500;
        text-align: right;
      }

      .mini-percent {
        font-size: 11px;
        color: var(--text-secondary);
      }

      /* Weekly pattern */

      #weekly-card {
        grid-area: weekly;
      }

      .heatmap-grid {
        margin-top: 6px;
        display: grid;
        grid-template-columns: 40px 1fr;
        gap: 8px;
        align-items: stretch;
      }

      .heatmap-days {
        display: flex;
        flex-direction: column;
        gap: 3px;
        font-size: 11px;
        color: var(--text-muted);
        padding-top: 4px;
      }

      .heatmap-cells {
        display: grid;
        grid-template-columns: repeat(24, minmax(0, 1fr));
        gap: 2px;
      }

      .heat-cell {
        width: 100%;
        padding-top: 16%;
        border-radius: 3px;
        background: rgba(255, 255, 255, 0.02);
      }

      .heat-cell[data-level="1"] {
        background: rgba(10, 132, 255, 0.22);
      }

      .heat-cell[data-level="2"] {
        background: rgba(10, 132, 255, 0.4);
      }

      .heat-cell[data-level="3"] {
        background: rgba(10, 132, 255, 0.7);
      }

      .heat-axis {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 6px;
      }

      /* Highlights */

      #highlights-card {
        grid-area: highlights;
      }

      .highlights-list {
        margin-top: 4px;
        list-style: none;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
      }

      .highlights-list li {
        display: flex;
        justify-content: space-between;
        color: var(--text-secondary);
      }

      .highlights-label {
        color: var(--text-muted);
      }

      .muted-note {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 6px;
      }

      /* Empty state */

      .empty {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.12),
          rgba(255, 255, 255, 0.04)
        );
        background-size: 200% 100%;
        animation: shimmer 1.3s infinite;
        border-radius: 999px;
        height: 8px;
      }

      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <header class="top-bar">
        <div class="top-left">
          <div class="app-title-row">
            <span class="status-dot"></span>
            <h1>USC Gym Live</h1>
          </div>
          <div class="subtitle">
            Quick view of how busy Village, Lyon, and HSC are right now.
          </div>
        </div>
        <div class="top-right">
          <div class="chip">USC Rec Sports · Internal</div>
          <div class="chip">
            <span class="pill-dot"></span>
            <span id="live-pill-text">Live</span>
          </div>
        </div>
      </header>

      <main class="grid">
        <!-- Today vs usual -->
        <section id="today-card" class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title-group">
                <div class="card-title">Today vs usual</div>
                <div class="card-subtitle">
                  How busy this room is today compared to a normal day.
                </div>
              </div>
              <div class="card-meta">
                <div class="select-wrapper">
                  <select id="room-select"></select>
                </div>
                <div class="meta-value" id="today-date-label"></div>
              </div>
            </div>

            <div class="today-main-row">
              <div class="today-score">
                <div class="today-score-value" id="today-score-value">
                  --
                </div>
                <div class="today-score-label" id="today-score-caption">
                  Waiting for data…
                </div>
                <span class="pill-status" id="today-status-pill">
                  <span class="pill-status-dot"></span>
                  <span id="today-status-text">Unknown</span>
                </span>
              </div>
              <div class="chart-wrapper">
                <canvas id="today-chart" height="120"></canvas>
                <div class="chart-legend">
                  <div class="legend-item">
                    <span class="legend-swatch legend-today"></span>Today
                  </div>
                  <div class="legend-item">
                    <span class="legend-swatch legend-typical"></span>Usual
                  </div>
                </div>
                <div class="chart-caption">
                  Blue line is today. Dotted line is the average of the last few
                  days.
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Current room -->
        <section id="current-card" class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title-group">
                <div class="card-title" id="current-room-label">
                  Village cardio floor
                </div>
                <div class="card-subtitle">Current occupancy</div>
              </div>
              <div class="card-meta">
                <div class="current-count">
                  <span id="current-count-value">--</span>
                  <span class="current-capacity" id="current-capacity-value"
                    >/ --</span
                  >
                </div>
                <div class="current-label">people right now</div>
                <div class="current-updated" id="current-updated-label">
                  Updated: --
                </div>
              </div>
            </div>

            <div class="mini-grid" id="mini-rooms"></div>
          </div>
        </section>

        <!-- Weekly pattern -->
        <section id="weekly-card" class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title-group">
                <div class="card-title">Weekly pattern</div>
                <div class="card-subtitle">
                  Average fullness by day and hour.
                </div>
              </div>
            </div>
            <div id="weekly-container">
              <div class="heatmap-grid">
                <div class="heatmap-days" id="heatmap-days"></div>
                <div class="heatmap-cells" id="heatmap-cells"></div>
              </div>
              <div class="heat-axis">
                <span>12 AM</span>
                <span>Noon</span>
                <span>6 PM</span>
                <span>12 AM</span>
              </div>
              <div class="chart-caption">
                Darker cells mean busier. Based on recent days for this room.
              </div>
            </div>
            <div id="weekly-empty" class="empty" style="display: none">
              Not enough history yet. This will fill in as your logger runs.
            </div>
          </div>
        </section>

        <!-- Highlights -->
        <section id="highlights-card" class="card">
          <div class="card-inner">
            <div class="card-header">
              <div class="card-title-group">
                <div class="card-title">Highlights</div>
                <div class="card-subtitle">
                  Typical pattern based on your logs.
                </div>
              </div>
            </div>
            <ul class="highlights-list" id="highlights-list">
              <li>
                <span class="highlights-label">Busiest hour</span>
                <span id="highlight-busiest">--</span>
              </li>
              <li>
                <span class="highlights-label">Quietest hour</span>
                <span id="highlight-quietest">--</span>
              </li>
              <li>
                <span class="highlights-label">Typical peak</span>
                <span id="highlight-peak">--</span>
              </li>
              <li>
                <span class="highlights-label">Right now</span>
                <span id="highlight-now">--</span>
              </li>
            </ul>
            <div class="muted-note">
              The longer your cron runs, the smarter this gets.
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      // Friendly names -> keep API keys as values
      const ROOM_OPTIONS = [
        { api: "UV Cardio Landing", label: "Village cardio floor" },
        { api: "UV Strength Room", label: "Village strength floor" },
        { api: "LRC Weight Room", label: "Lyon weight room" },
        { api: "HSC Weight Room", label: "HSC weight room" },
      ];

      const roomSelect = document.getElementById("room-select");
      const todayScoreValue = document.getElementById("today-score-value");
      const todayScoreCaption = document.getElementById("today-score-caption");
      const todayStatusPill = document.getElementById("today-status-pill");
      const todayStatusText = document.getElementById("today-status-text");
      const todayChartEl = document.getElementById("today-chart");
      const todayDateLabel = document.getElementById("today-date-label");

      const currentRoomLabel = document.getElementById("current-room-label");
      const currentCountValue = document.getElementById("current-count-value");
      const currentCapacityValue = document.getElementById(
        "current-capacity-value",
      );
      const currentUpdatedLabel = document.getElementById(
        "current-updated-label",
      );
      const miniRoomsContainer = document.getElementById("mini-rooms");

      const heatmapDaysEl = document.getElementById("heatmap-days");
      const heatmapCellsEl = document.getElementById("heatmap-cells");
      const weeklyContainer = document.getElementById("weekly-container");
      const weeklyEmpty = document.getElementById("weekly-empty");

      const highlightBusiest = document.getElementById("highlight-busiest");
      const highlightQuietest = document.getElementById("highlight-quietest");
      const highlightPeak = document.getElementById("highlight-peak");
      const highlightNow = document.getElementById("highlight-now");
      const livePillText = document.getElementById("live-pill-text");

      function formatTimeLabel(iso) {
        if (!iso) return "--";
        const d = new Date(iso);
        return d.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });
      }

      function formatHour(h) {
        const date = new Date();
        date.setHours(h, 0, 0, 0);
        return date.toLocaleTimeString([], { hour: "numeric" });
      }

      function classifyStatus(percent) {
        if (percent == null || Number.isNaN(percent)) return "unknown";
        if (percent < 35) return "ok";
        if (percent < 70) return "moderate";
        return "busy";
      }

      function setStatusPill(pill, textEl, percent) {
        const status = classifyStatus(percent);
        pill.classList.remove("ok", "busy");
        if (status === "ok") {
          pill.classList.add("ok");
          textEl.textContent = "Usually manageable";
        } else if (status === "busy") {
          pill.classList.add("busy");
          textEl.textContent = "Very busy";
        } else {
          textEl.textContent = "Moderate";
        }
      }

      function drawTodayChart(ctx, todaySeries, typicalSeries) {
        const width = ctx.canvas.width;
        const height = ctx.canvas.height;
        ctx.clearRect(0, 0, width, height);

        if (!todaySeries || todaySeries.length === 0) {
          ctx.fillStyle = "rgba(255,255,255,0.18)";
          ctx.fillRect(0, height / 2 - 1, width, 2);
          return;
        }

        const maxPercent = 100;
        const maxHour = 23;

        function scaleX(hour) {
          return (hour / maxHour) * (width - 20) + 10;
        }
        function scaleY(percent) {
          const p = Math.max(0, Math.min(maxPercent, percent));
          return height - 18 - (p / maxPercent) * (height - 28);
        }

        // Axes baseline
        ctx.strokeStyle = "rgba(255,255,255,0.14)";
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(10, height - 18);
        ctx.lineTo(width - 10, height - 18);
        ctx.stroke();

        if (typicalSeries && typicalSeries.length) {
          ctx.setLineDash([4, 3]);
          ctx.strokeStyle = "rgba(255,255,255,0.65)";
          ctx.lineWidth = 1.2;
          ctx.beginPath();
          typicalSeries.forEach((pt, idx) => {
            const x = scaleX(pt.hour);
            const y = scaleY(pt.percent);
            if (idx === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          });
          ctx.stroke();
          ctx.setLineDash([]);
        }

        ctx.strokeStyle = "#0a84ff";
        ctx.lineWidth = 1.8;
        ctx.beginPath();
        todaySeries.forEach((pt, idx) => {
          const x = scaleX(pt.hour);
          const y = scaleY(pt.percent);
          if (idx === 0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        });
        ctx.stroke();
      }

      function buildRoomSelect() {
        ROOM_OPTIONS.forEach((r) => {
          const opt = document.createElement("option");
          opt.value = r.api;
          opt.textContent = r.label;
          roomSelect.appendChild(opt);
        });
      }

      async function fetchLive() {
        const res = await fetch("/api/live");
        if (!res.ok) throw new Error("live fetch failed");
        return res.json();
      }

      async function fetchHistory(roomApiName) {
        const res = await fetch(
          `/api/history?area=${encodeURIComponent(roomApiName)}`,
        );
        if (!res.ok) throw new Error("history fetch failed");
        return res.json();
      }

      function updateMiniCards(liveData) {
        miniRoomsContainer.innerHTML = "";

        // We allow either {areas: {...}} or flat object
        const areas = liveData.areas || liveData.rooms || liveData;

        ROOM_OPTIONS.forEach((opt) => {
          const raw = areas[opt.api];
          if (!raw) return;

          const current =
            raw.current ?? raw.count ?? raw.value ?? raw.people ?? null;
          const capacity = raw.capacity ?? raw.max ?? null;
          const percent =
            raw.percent_full ??
            raw.percent ??
            (capacity ? (current / capacity) * 100 : null);

          const card = document.createElement("div");
          card.className = "mini-card";

          const left = document.createElement("div");
          const name = document.createElement("div");
          name.className = "mini-name";
          name.textContent = opt.label;
          const sub = document.createElement("div");
          sub.className = "mini-sub";
          sub.textContent = capacity
            ? "Capacity " + capacity
            : "Live count only";

          left.appendChild(name);
          left.appendChild(sub);

          const right = document.createElement("div");
          right.style.textAlign = "right";
          const value = document.createElement("div");
          value.className = "mini-value";
          value.textContent =
            current != null && !Number.isNaN(current) ? current : "--";
          const p = document.createElement("div");
          p.className = "mini-percent";
          p.textContent =
            percent != null && !Number.isNaN(percent)
              ? Math.round(percent) + "% full"
              : "";

          right.appendChild(value);
          right.appendChild(p);

          card.appendChild(left);
          card.appendChild(right);
          miniRoomsContainer.appendChild(card);
        });
      }

      function updateCurrentRoom(liveData, roomApiName) {
        const areas = liveData.areas || liveData.rooms || liveData;
        const entry = areas[roomApiName];
        const friendly = ROOM_OPTIONS.find((r) => r.api === roomApiName);

        currentRoomLabel.textContent = friendly
          ? friendly.label
          : roomApiName;

        if (!entry) {
          currentCountValue.textContent = "--";
          currentCapacityValue.textContent = "/ --";
          currentUpdatedLabel.textContent = "Updated: --";
          highlightNow.textContent = "--";
          return;
        }

        const current =
          entry.current ?? entry.count ?? entry.value ?? entry.people ?? null;
        const capacity = entry.capacity ?? entry.max ?? null;
        const percent =
          entry.percent_full ??
          entry.percent ??
          (capacity ? (current / capacity) * 100 : null);

        currentCountValue.textContent =
          current != null && !Number.isNaN(current) ? current : "--";
        currentCapacityValue.textContent = capacity ? ` / ${capacity}` : "";
        currentUpdatedLabel.textContent = entry.read_at
          ? "Updated: " + formatTimeLabel(entry.read_at)
          : "Updated: just now";

        if (percent != null && !Number.isNaN(percent)) {
          highlightNow.textContent = `${Math.round(percent)}% full right now`;
        } else {
          highlightNow.textContent = "--";
        }
      }

      function updateWeekly(history) {
        // History format: { heatmap: [{dow, hour, percent}, ...], insights: {...} }
        const heat = history.heatmap || history.weekly || [];
        if (!heat.length) {
          weeklyContainer.style.display = "none";
          weeklyEmpty.style.display = "block";
          return;
        }

        weeklyContainer.style.display = "block";
        weeklyEmpty.style.display = "none";

        const daysShort = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        heatmapDaysEl.innerHTML = "";
        daysShort.forEach((d) => {
          const div = document.createElement("div");
          div.textContent = d;
          heatmapDaysEl.appendChild(div);
        });

        heatmapCellsEl.innerHTML = "";
        // Build 7 x 24 grid (Mon=0 .. Sun=6)
        const matrix = Array.from({ length: 7 }, () =>
          Array(24).fill(null),
        );
        heat.forEach((pt) => {
          const dow = pt.dow ?? pt.day ?? 0;
          const hour = pt.hour ?? 0;
          const percent = pt.percent ?? pt.percent_full ?? 0;
          if (dow >= 0 && dow < 7 && hour >= 0 && hour < 24) {
            matrix[dow][hour] = percent;
          }
        });

        // Flatten row-major: for each day, then hour
        matrix.forEach((row) => {
          row.forEach((percent) => {
            const cell = document.createElement("div");
            cell.className = "heat-cell";
            if (percent != null) {
              let level = 0;
              if (percent >= 70) level = 3;
              else if (percent >= 45) level = 2;
              else if (percent >= 25) level = 1;
              if (level > 0) cell.dataset.level = String(level);
            }
            heatmapCellsEl.appendChild(cell);
          });
        });

        if (history.insights) {
          const ins = history.insights;
          if (ins.busiest_hour != null) {
            highlightBusiest.textContent =
              formatHour(ins.busiest_hour) +
              (ins.busiest_percent != null
                ? ` · ${Math.round(ins.busiest_percent)}%`
                : "");
          }
          if (ins.quietest_hour != null) {
            highlightQuietest.textContent =
              formatHour(ins.quietest_hour) +
              (ins.quietest_percent != null
                ? ` · ${Math.round(ins.quietest_percent)}%`
                : "");
          }
          if (ins.peak_percent != null) {
            highlightPeak.textContent =
              Math.round(ins.peak_percent) + "% typical peak";
          }
        }
      }

      function updateToday(history) {
        const todaySeries =
          history.today ??
          history.today_series ??
          history.points ??
          history.series ??
          [];
        const typicalSeries =
          history.typical ?? history.typical_series ?? history.baseline ?? [];

        const ctx = todayChartEl.getContext("2d");
        drawTodayChart(ctx, todaySeries, typicalSeries);

        if (!todaySeries.length) {
          todayScoreValue.textContent = "--";
          todayScoreCaption.textContent = "Waiting for data…";
          setStatusPill(todayStatusPill, todayStatusText, null);
          return;
        }

        const last = todaySeries[todaySeries.length - 1];
        const currentPercent = last.percent ?? last.percent_full ?? null;
        todayScoreValue.textContent =
          currentPercent != null && !Number.isNaN(currentPercent)
            ? Math.round(currentPercent)
            : "--";

        todayScoreCaption.textContent = "Average fullness so far today.";
        setStatusPill(todayStatusPill, todayStatusText, currentPercent);

        const today = new Date();
        todayDateLabel.textContent = today.toLocaleDateString(undefined, {
          weekday: "short",
          month: "short",
          day: "numeric",
        });
      }

      async function refresh(roomApiName) {
        try {
          const [live, history] = await Promise.all([
            fetchLive(),
            fetchHistory(roomApiName),
          ]);

          livePillText.textContent = "Live · just updated";
          updateMiniCards(live);
          updateCurrentRoom(live, roomApiName);
          updateToday(history);
          updateWeekly(history);
        } catch (e) {
          console.error(e);
        }
      }

      function init() {
        buildRoomSelect();
        const initialRoom = ROOM_OPTIONS[0].api;
        roomSelect.value = initialRoom;
        refresh(initialRoom);

        roomSelect.addEventListener("change", () => {
          refresh(roomSelect.value);
        });

        // Poll every 3 minutes for live refresh
        setInterval(() => {
          refresh(roomSelect.value);
        }, 180000);
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
